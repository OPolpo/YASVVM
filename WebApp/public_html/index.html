<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <style type="text/css">
            html { height: 99%; }
            body { height: 99%; margin: auto; padding: 0; border:red solid thick }
            #map-canvas { height: 100%; width: 70%; margin: 0 auto}
        </style>
        <script type="text/javascript"
                src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDEJC-PgZ6svbQX9w6trM8NTZysSFU-inw">
        </script>
        <script type="text/javascript">
            var map, startPositionMarker, endPositionMarker, lastStartValidPosition, lastEndValidPosition, streetViewService;
            
            function initialize()
            {
                var mapOptions = {
                    //center: new google.maps.LatLng(45.563944, 10.231333),
                    center: new google.maps.LatLng(0, 0),
                    zoom: 16,
                    disableDefaultUI: true,
                    //panControl: true,
                    //scaleControl: true,
                    //overviewMapControl: true
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_BOTTOM
                    },
                };
                map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
                
                // W3C Geolocation
                /*if(navigator.geolocation)
                {
                    browserSupportFlag = true;
                    alert("positione iniziale: "+navigator.geolocation.getCurrentPosition());
                    navigator.geolocation.getCurrentPosition(function(position){
                        initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
                        alert("positione iniziale: "+initialiLocation);
                        map.setCenter(initialLocation);
                    });
                }// else put to default location (unibs)*/
        
        // Try HTML5 geolocation
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = new google.maps.LatLng(position.coords.latitude,
                                       position.coords.longitude);

        alert(pos);

      var infowindow = new google.maps.InfoWindow({
        map: map,
        position: pos,
        content: 'Location found using HTML5.'
      });

      map.setCenter(pos);
    }, function() {
      // do nothing cause use default value, maybe an alert?
    });
  } else {
    // Browser doesn't support Geolocation
    // do nothing cause use default value, maybe an alert?
  }
                
                streetViewService = new google.maps.StreetViewService();
                streetViewLayer = new google.maps.StreetViewCoverageLayer();
                streetViewLayer.setMap(map);
                
                //Check in a perimeter of 1000 meters 
                initializeStartEndPosition();
            }
            
            function initializeStartEndPosition()
            {
                streetViewService.getPanoramaByLocation(map.getCenter(), 50, function checkNearestStreetView(data, status){
                    if(status == google.maps.StreetViewStatus.OK)
                    {
                        //alert(data.location.latLng);
                        startPositionMarker = new google.maps.Marker({
                            position: data.location.latLng,
                            draggable:true,
                            //labelClass: "labels", // the CSS class for the label
                            //labelInBackground: false
                            title:"StartPosition"
                        });
                        
                        lastValidStartPosition = startPositionMarker.position;
                        
                        endPositionMarker = new google.maps.Marker({
                            position: data.location.latLng,
                            draggable:true,
                            title:"EndPosition"
                        });
                        
                        lastValidEndPosition = endPositionMarker.position;
                        
                        startPositionMarker.setMap(map);
                        endPositionMarker.setMap(map);
                        
                        //animation and end animation
                        endPositionMarker.setAnimation(google.maps.Animation.BOUNCE);
                        google.maps.event.addListener(endPositionMarker, 'dragstart', function stopBounce(){
                            endPositionMarker.setAnimation(null);
                            google.maps.event.clearListeners(endPositionMarker, 'dragstart');
                        });
                        
                        // add listner on drop, check if is a street view location
                        google.maps.event.addListener(startPositionMarker, 'dragend', checkStreetViewStart);
                        google.maps.event.addListener(endPositionMarker, 'dragend', checkStreetViewEnd);
                    }
                    else
                    {
                        alert(status);
                        //alert("nessuna street view nelle vicinanze ["+map.getCenter()+"],\nti spostiamo sulla default location");
                        map.setCenter(new google.maps.LatLng(45.563944, 10.231333));
                        initializeStartEndPosition();
                    }
                });
            }
            
            function checkStreetViewStart(data)
            {
                checkStreetView(startPositionMarker, data);
            }
            
            function checkStreetViewEnd(data)
            {
                checkStreetView(endPositionMarker, data);
            }
            
            function checkStreetView(marker, data)
            {
                streetViewService.getPanoramaByLocation(data.latLng, 50, function processSVData(data, status){
                    if(status == google.maps.StreetViewStatus.OK)
                    {
                        marker.setPosition(data.location.latLng);
                        if(marker == startPositionMarker)
                        {
                            lastValidStartPosition = startPositionMarker.position;
                        }else
                        {
                            lastValidEndPosition = endPositionMarker.position;
                        }
                    }
                    else
                    {
                        if(marker == startPositionMarker)
                        {
                            marker.setPosition(lastValidStartPosition);
                        }
                        else
                        {
                            marker.setPosition(lastValidEndPosition);
                        }
                    }
                });
            }
            
            function stopBounce()
            {
                //if (endPositionMarker.getAnimation() != null)
                //{
                endPositionMarker.setAnimation(null);
                google.maps.event.clearListeners(endPositionMarker, 'dragstart');
                //}
            }
            
            google.maps.event.addDomListener(window, 'load', initialize);
        </script>
    </head>
    <body>
        <div id="map-canvas"/>
    </body>
</html>