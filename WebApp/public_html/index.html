<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <style type="text/css">
            html { height: 99%; }
            body { height: 99%; margin: auto; padding: 0; border:red solid thick }
            #map-canvas { height: 100%; width: 70%; margin: 0 auto}
        </style>
        <script type="text/javascript"
                src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDEJC-PgZ6svbQX9w6trM8NTZysSFU-inw">
        </script>
        <script type="text/javascript">
            var map, streetViewService, directionsDisplay, directionsService;
            var startPositionMarker, endPositionMarker, lastStartValidPosition, lastEndValidPosition;
            var routeMarker = [];
            var total = 0;
            
            function initialize()
            {
                var mapOptions = {
                    center: new google.maps.LatLng(45.563944, 10.231333),
                    //center: new google.maps.LatLng(0, 0),
                    zoom: 16,
                    disableDefaultUI: true,
                    //panControl: true,
                    //scaleControl: true,
                    //overviewMapControl: true
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_BOTTOM
                    },
                };
                map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
                
                var polylineOptionsValue = new google.maps.Polyline({
                    strokeColor: '#00FF00',
                    strokeOpacity: 0.5,
                    strokeWeight: 7,
                });
                
                rendererOptions = {
                    //draggable: true, //per attivare draggable, bisogna aggiungere la gestione del trascinamento dei markers
                    suppressMarkers: true,
                    //suppressInfoWindows: true,
                    polylineOptions: polylineOptionsValue
                };
                directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
                //directionsDisplay = new google.maps.DirectionsRenderer();
                directionsService = new google.maps.DirectionsService();
                geocoder = new google.maps.Geocoder();
                
                // HTML5 geolocation
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var pos = new google.maps.LatLng(position.coords.latitude,
                        position.coords.longitude);
                        
                        /*var infowindow = new google.maps.InfoWindow({
                            map: map,
                            position: pos,
                            content: 'Location found using HTML5.'
                        });*/
                        
                        //alert(pos+" , "+map.getCenter());
                        map.setCenter(pos);
                        //alert(pos+" , "+map.getCenter());
                        continueInizialization();
                    }, function() {
                        // do nothing cause use default value, maybe an alert?
                        //alert("attento, sono qui");
                        alert("geolocalizzazione non attiva,\nti spostiamo sulla default location");
                        continueInizialization();
                    });
                } else {
                    // Browser doesn't support Geolocation
                    // do nothing cause use default value, maybe an alert?
                    //alert("attento, sono qui2");
                    alert("geolocalizzazione non attiva,\nti spostiamo sulla default location");
                    continueInizialization();
                }
                
                //alert(map.getCenter());
            }
            
            function continueInizialization()
            {
                streetViewService = new google.maps.StreetViewService();
                streetViewLayer = new google.maps.StreetViewCoverageLayer();
                streetViewLayer.setMap(map);
                directionsDisplay.setMap(map);
                initializeStartEndPosition();
            }
            
            function initializeStartEndPosition()
            {
                //alert(map.getCenter());
                streetViewService.getPanoramaByLocation(map.getCenter(), 100, function checkNearestStreetView(data, status){
                    if(status == google.maps.StreetViewStatus.OK)
                    {
                        //alert(data.location.latLng);
                        startPositionMarker = new google.maps.Marker({
                            position: data.location.latLng,
                            draggable:true,
                            //labelClass: "labels", // the CSS class for the label
                            //labelInBackground: false
                            title:"StartPosition"
                        });
                        
                        lastValidStartPosition = startPositionMarker.position;
                        
                        endPositionMarker = new google.maps.Marker({
                            position: data.location.latLng,
                            draggable:true,
                            title:"EndPosition"
                        });
                        
                        lastValidEndPosition = endPositionMarker.position;
                        
                        startPositionMarker.setMap(map);
                        endPositionMarker.setMap(map);
                        
                        //animation and end animation
                        endPositionMarker.setAnimation(google.maps.Animation.BOUNCE);
                        google.maps.event.addListener(endPositionMarker, 'dragstart', function stopBounce(){
                            endPositionMarker.setAnimation(null);
                            google.maps.event.clearListeners(endPositionMarker, 'dragstart');
                        });
                        
                        // add listner on drop, check if is a street view location
                        google.maps.event.addListener(startPositionMarker, 'dragend', checkStreetViewStart);
                        google.maps.event.addListener(endPositionMarker, 'dragend', checkStreetViewEnd);
                    } else {
                        alert("nessuna street view nelle vicinanze, ti spostiamo sulla default location");
                        map.setCenter(new google.maps.LatLng(45.563944, 10.231333));
                        initializeStartEndPosition();
                    }
                });
                // start and end position enstablished
                
            }
            
            function checkStreetViewStart(data)
            {
                checkStreetView(startPositionMarker, data);
            }
            
            function checkStreetViewEnd(data)
            {
                checkStreetView(endPositionMarker, data);
            }
            
            function checkStreetView(marker, data)
            {
                streetViewService.getPanoramaByLocation(data.latLng, 50, function processSVData(data, status){
                    if(status == google.maps.StreetViewStatus.OK)
                    {
                        marker.setPosition(data.location.latLng);
                        if(marker == startPositionMarker)
                        {
                            lastValidStartPosition = startPositionMarker.position;
                            calculateRoute();
                        }else
                        {
                            lastValidEndPosition = endPositionMarker.position;
                            calculateRoute();
                        }
                    }
                    else
                    {
                        if(marker == startPositionMarker)
                        {
                            marker.setPosition(lastValidStartPosition);
                        }
                        else
                        {
                            marker.setPosition(lastValidEndPosition);
                        }
                    }
                });
            }
            
            function calculateRoute()
            {
                while(routeMarker.length)
                {
                    routeMarker[routeMarker.length-1].setMap(null);
                    //routeMarker[routeMarker.length-1] = null;
                    routeMarker.splice(routeMarker.length-1,1);
                }
                var request = {
                    origin: lastValidStartPosition,
                    destination: lastValidEndPosition,
                    // Note that Javascript allows us to access the constant
                    // using square brackets and a string value as its
                    // "property."
                    travelMode: google.maps.TravelMode.DRIVING
                    //travelMode: google.maps.TravelMode.WALKING
                };
                directionsService.route(request, function(data, status)
                {
                    if (status == google.maps.DirectionsStatus.OK)
                    {
                        //console.log(data);
                        directionsDisplay.setDirections(data);
                        elaborateRoutes(data.routes[0].legs[0],0,0);
                    }
                });
            }
            
            
            function elaborateRoutes(data,i,j)
            {
                streetViewService.getPanoramaByLocation(data.steps[i].path[j], 5, function processSVData(svData, status){
                    if(status == google.maps.StreetViewStatus.OK)
                    {
                        alreadyExist = false;
                        for(k=1;k<=4&&routeMarker.length-k>=0;k++)
                        {
                            if(routeMarker[routeMarker.length-k].pano == svData.location.pano)
                            {
                                alreadyExist = true;
                                break;
                            }
                        }
                        if(alreadyExist)
                        {
                            //console.log("already exist"+svData.location.pano);
                        }
                        else
                        {
                            routeMarker[routeMarker.length] = new google.maps.Marker({
                                map: map,
                                position: svData.location.latLng, //move from direct position to street map position,
                                pano: svData.location.pano,
                                //and usefull to check if exist or not street view image in that way
                                title:"Step: ["+i+","+j+"]"
                            });
                            total++;
                            console.log(total + " " +  svData.location.latLng + " " + svData.location.pano);
                        }
                    }
                    else
                    {
                        console.log("no street view near route: "+status);
                    }
                    //prossimo punto
                    j++;
                    if(j<data.steps[i].path.length)
                    {
                        elaborateRoutes(data,i,j);
                    }
                    else
                    {
                        i++;
                        if(i<data.steps.length)
                        {
                            elaborateRoutes(data,i,0);
                        }
                    }
                });
            }
            
            google.maps.event.addDomListener(window, 'load', initialize);
        </script>
    </head>
    <body>
        <div id="map-canvas" ></div>
    </body>
</html>